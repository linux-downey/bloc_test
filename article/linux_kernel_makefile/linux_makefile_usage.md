# linux Kbuild系统详解(1) - 内核的编译操作  

## 前言  
对于linux的学习而言，我想大部分人遇到的第一个坎就是linux的内核编译了吧，想当初我从windows系统刚开始转而学习linux开发的时候，编译linux的内核就是特别让我兴奋的一件事，觉得自己进入了一个自由的世界：连操作系统源代码都是自己编译的，以后我想怎么玩就怎么玩了。刹那间连敲击键盘的手都变得轻快了起来，仿佛连空气都变得自由。   

随着学习的深入，我逐渐发现了一个linux开发中一个非常残酷的事实，也就是自由的代价：如果你只是跟着教程敲指令而不知道自己究竟在做什么，linux总是会百般地刁难你，直到你弄清楚原理或者是放弃。   

原来，自由只是对强者而言，而灵活，也意味着复杂。   

既然如此，那就无路可退，只能操起键盘就是干。  

****  

## 总览
本博客为系列作品，将会详细介绍从linux内核的编译操作到linux内核的编译安装的流程，也就是linux的Kbuild系统，在博主看来，整个Kbuild的系统的复杂性是比较高的，建议你看这个博客之前先重温Makefile的知识点。   

当然，对Makefile的掌握要求并不仅仅是简单地对着网上的模板能进行对应的增删改查，而需要对Makefile的语法有一个整体的掌握，对于这一部分，可以参考博主之前的系列博客：[深入理解Makefile系列](http://www.downeyboy.com/2019/05/15/makefile_series_0/)。   


相信我，如果你对linux 内核的编译安装机制有了一定的了解，对你之后的linux配置、调试、开发都将起到至关重要的作用。   

好了，废话不多说，我们先开始第一章的内容：内核的编译操作。  

*****   

## 内核的编译  
之所以首先讲内核的编译，是希望能从应用开始，带着疑问一步步深入，然后解析整体框架，如果一上来就是整个框架的解析，那么这将是一件非常无聊的事情，但是，学习本来应该是一件有趣的事情，对吧。  

****

### 第一步 ： 下载源码
想编译源码当然第一步是下载它，目前linux的代码被托管到github上，这也是最主流的代码管理方式，直接在github的搜索栏输入linux，就可以看到torvalds/linux。   

没错，作者就是大名鼎鼎的linus torvalds，这是linux的主线代码，值得注意的是，大部分嵌入式的linux发行版都和主线代码有区别，具体的下载方式那就因厂商而异了。  

下载：  

```
git clone https://github.com/torvalds/linux.git
```

****  

### 第二步 ： 配置
下载下来源代码之后，进入到源代码根目录，我们需要对源代码进行配置。  

****  

#### 为什么要配置
我希望你看到第二步的标题就能想到这个问题，为什么要配置？    

linux实现的各种功能是以模块的形式存在的，比如存储、时钟、外设或者平台相关的功能选择等等，对于系统非必须的模块，linux内核支持动态地加(卸)载，用户可以指定将模块编译到内核镜像中还是编译成外部模块。通过这些配置，我们可以非常方便地对linux内核大小进行裁剪，这对于很多内存受限的嵌入式设备是非常重要的。  

****

####  怎么配置
通常，linux的配置方式主要是对各种模块进行选择，其中包括对平台的选择，大部分模块都有三种选择：
* Y - 将该模块编译进内核
* M - 将模块编译成外部模块
* N - 不对这个模块进行处理

而配置的方式有很多种，都是在源代码根目录下敲以下相应的命令：
* make config ： 这是linux内核配置的祖师爷了，对于每个模块，在终端将逐个询问你的配置意向：Y/N/M，这个配置方式基本不用了，太过于麻烦。  
* make xxx_defconfig : 按照对应平台的默认配置方式来配置，可以在 **\$(SRC_ROOT)/arch/\$(ARCH)/configs**中找到对应的**xxx_def_config**。  
    比如x86平台，执行 **make i386_defconfig** 就是按照 **arch/x86/configs/i386_defconfig** 这个文件进行配置。  


#### 架构选择





## 结语
如果在工作或学习中，你总是能问上一句为什么，那么我觉得你已经有了成为一个优秀工程师的特质。   

是的，这一章节一直在告诉你怎么做。那么，从下一章节开始，我将告诉你为什么这么做可以编译整个源代码。  





