# systemd-2-unit 单元文件
如果不涉及到复杂的应用，系统管理员基本上只会接触到 service 配置文件，当我们要对某个服务程序进行管理时，编写一个 service 文件，指定服务开启、关闭时对应的指令，就可以通过 systemd 对该服务进行控制了("服务"这个概念本来是针对系统提供的 daemon 程序而言，比如 ssh、login，在本章中这个概念被引用到所有实现某个具体功能的进程或进程组，比如一个 QT 交互界面程序，尽管它可能是一个客户端程序).  

实际上，systemd 的配置文件分为多种，分别针对多种服务的配置，这些不同后缀的配置文件统称为单元文件(unit)，systemd 从系统目录下读取这些单元文件对服务进行相应的配置。  

单元文件是 ini 风格的纯文本文件。 封装了以下对象的信息：服务(service)、套接字(socket)、设备(device)、挂载点(mount)、自动挂载点(automount)、 启动目标(target)、交换分区或交换文件(swap)、被监视的路径(path)、定时任务(timer)、 资源控制组(slice)、一组外部创建的进程(scope)。    

以下列出常用的几种文件的简短介绍：
* service：以 .service 为后缀的文件，这是最常见的配置文件，针对服务相关的设置，包括服务的启停、开机启动所对应的指令，同时兼容 sysvinit 系统，能够读取 sysvinit 脚本，比如 /etc/init.d/ 目录下的文件，rc-local 等，sysvinit 系统的开机自启动一般是两种方式：
    * 将启动脚本放到 /etc/init.d/ 目录下，再使用 update-rc.d 指令更新开机启动设置
    * 直接在 /etc/rc.local 文件中添加启动指令，rc.local 会在启动的最后阶段被执行。 
    这两种方式都可以被 systemd 直接支持。

* socket：以 .socket 为后缀的文件，该单元将套接字封装在文件系统或网络上。当前支持流、数据报和顺序包类型的AF_INET，AF_INET6，AF_UNIX套接字。同时还支持经典FIFO作为传输方式。套接字文件中通常包含了其在套接字文件在系统中的目录、文件权限、buffer 大小等等。套接字文件不会被当成某个服务启动，都是通过依赖关系被系统自动启动。    

* device：.device 为后缀的文件，针对 linux 中的设备文件的配置，实际上这种类型的配置文件用得不多，所有硬件设备都由内核进行管理，当设备初始化、添加或者删除时，内核通过 netlink 发送消息到用户空间，用户空间统一通过 udev 接收并处理，执行用户指定的脚本或者是创建一些设备节点，需要使用 .device 文件来描述的情况并不多。

* mount: .mount 文件用于指定文件系统的加载点，这个文件系统可能是磁盘文件系统，也可能是基于 RAM 的文件系统，原本的 /etc/fstab 依旧可用，.mount 文件通常需要提供文件系统类型、挂载点等信息。  

* target：.target 文件是单元文件的逻辑分组，也就是说，单个服务配置文件通常是为了完成某个特定的功能，比如启动 ssh、login，当系统需要达到某个状态或者实现某个相对复杂的功能需求时，需要多个服务的组合，比如需要完成 sysinit，即系统初始化工作，需要先完成文件系统、交换分区、硬件设备的初始化，target 文件就是负责管理多个服务的分组，以组为单位对服务进行管理以实现特定的需求而不再是单个的程序，target 文件通常被用在服务的依赖条目中。  

* snapshot：快照文件，类似于目标单元的快照，它本身并不会做任何事情，它们的唯一目的是引用其他单元。快照可用于保存/回滚init系统的所有服务和单元的状态。主要的用途为：允许用户暂时进入特定状态 (例如 resecu 状态)，终止当前服务，并提供一种简单的方法来返回之前的状态。  


## 单元文件加载目录
在 systemd 开始运行的时候，会在一组指定的目录处读取单元文件并加载，下列是所有单元文件的系统路径，以单元文件的优先级进行排列，先列出的优先级较高，当系统中同时出现多个同名的单元文件时，存在于高优先级目录下的单元文件会覆盖低优先级目录下的文件：

当 systemd 以系统权限运行时(--system)，加载单元的目录(优先级从高到低排列)：TODO

当 systemd 以用户模式运行时，加载单元的目录(优先级从高到低排列)：TODO

上表中的 XDG_RUNTIME_DIR、XDG_CONFIG_HOME 是系统中的环境变量，环境变量可以通过特定的程序生成，systemd 中允许使用环境变量生成器来给环境变量赋值，生成器是 systemd 中一系列执行程序，这些程序在单元文件加载之前被执行，生成动态的单元文件或者环境变量。  




## 单元文件内容
单元文件被 systemd 读取，正如上文中的介绍，不同的单元文件对应不同的功能，尽管不同类型的单元文件有不同的配置，但是其格式是一样的，单元文件分为两个部分：
* 使用 [ ] 包括的 section，即小节，一个小节可包含多个描述字段
* 描述字段，也被称作指令，以键值对的形式，值可以是列表的形式

其中，小节是对多个描述字段的组织，而描述字段负责具体的功能描述，比如 service 文件中的 ExecStart=/bin/foo 表示开启该服务对应的指令为 /bin/foo. 在 systemd 的[指令手册](https://www.freedesktop.org/software/systemd/man/systemd.directives.html)中，详细地列出了所有的指令.  

无法识别的指令不会中断单元文件的加载，但是 systemd 会输出一条警告日志。 如果选项或者小节的名字以 X- 开头， 那么 systemd 将会完全忽略它。 以 X- 开头的小节中的选项没必要再以 X- 开头， 因为整个小节都已经被忽略。 应用程序可以利用这个特性在单元文件中包含额外的信息。  

如果想要给一个单元赋予别名，那么可以按照需求，在系统单元目录或用户单元目录中， 创建一个软连接(以别名作为文件名)，并将其指向该单元的单元文件。 例如 systemd-networkd.service 在安装时就通过 /usr/lib/systemd/system/dbus-org.freedesktop.network1.service 软连接创建了 dbus-org.freedesktop.network1.service 别名。   

此外，还可以直接在单元文件的 [Install] 小节中使用 Alias= 创建别名。 注意，单元文件中设置的别名会随着单元的启用(enable)与禁用(disable)而生效和失效， 也就是别名软连接会随着单元的启用(enable)与禁用(disable)而创建与删除。 例如，因为 reboot.target 单元文件中含有 Alias=ctrl-alt-del.target 的设置，。单元的别名可以用于 enable, disable, start, stop, status, … 这些命令中，也可以用于 Wants=, Requires=, Before=, After=, … 这些依赖关系选项中。 但是务必注意，不可将单元的别名用于 preset 命令中。 再次提醒，通过 Alias= 设置的别名仅在单元被启用(enable)之后才会生效。










