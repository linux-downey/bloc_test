# 链接脚本基本介绍

关于程序的静态链接的介绍在之前的文章:[程序的静态链接](http://www.downeyboy.com/2018/11/12/static-link/)中已经相应的介绍，在该文章中，从理论出发，描述了程序为什么需要链接，以及链接的方式。  

理论知识是必须的，也是基础，但是只有理论知识是完全不够的，我们需要深入到细节，看看链接过程到底是如何进行控制的，这就涉及到我们这章即将要讨论到的链接脚本。  


## 链接器
通常在编译程序的时候并没有太过于关注编译的流程，从 C 语言程序生成最后的可执行文件通常就是一条指令的事，实际上在编译的四个步骤中，并不一直是 "gcc" 单个程序在工作，gcc 在早期叫做 GNU C Compiler，而在后来计算机的发展中，GCC逐渐兼容了C++,java等语言，发展为扩展版的GCC，全称为 GNU compiler collection，事实上它是指一套编译处理工具，而不再是单纯的C编译器，像g++，其实也是属于GCC工具中的一种。  

在编译一个程序的时候可以添加上 -v 参数，在 gnu 的大多数工具中，-v 通常意思为 --verbose，即输出详细信息。从而，在输出的编译详细信息中，我们可以看到在编译 C 代码时，分别调用了 CPP、CC1、AS、COLLECT2 这四类编译工具，分别对应 预编译、编译、汇编、链接 这四个过程。  

```
在编译的时候尤其是在编写 Makefile 脚本的时候，需要注意 CPP 是预编译器，而不是 C++ 的意思，C++ 通常用 CXX 表示，这里有很多人会搞混。  
```

COLLECT2 对应链接过程，但它并不是链接器，它在链接器 ld 上做了一层封装，在链接之前对文件进行一些特殊的处理，最后再调用链接器 ld 进行工作。  


## 链接脚本的使用

程序的链接是一个单独的过程，尽管通常没有必要，但我们确实可以单独使用它：

```
ld  lib.o main.o -o main
```

该命令将两个目标文件 lib.o 和 main.o 链接成最终的可执行文件。  

在之前的文章中，我们了解到链接的过程分为三个部分：

* 空间和地址分配
* 符号解析
* 重定位


不知道你有没有过疑惑，链接器是如何执行这三个步骤的？尤其是对于空间和地址分配而言，可执行文件将会被加载到内存的何处并运行？每个单独的目标文件都存在那么多的段，这些段具体是如何被组织起来的？这些控制行为是由编译器自行决定还是可以人为干预？   

实际上，除了 lib.o 和 main.o 这两个显示的输入文件，还有一个隐式的输入文件，这个输入文件控制着程序的整个链接过程，即链接脚本，后缀为 lds。  

通常情况下，我们都察觉不到链接脚本的存在，这是因为通常我们在编译程序时都使用系统默认提供的链接脚本，如果不是高度自定义化的应用，默认的链接脚本完全可以胜任链接的工作。    

如果要查看系统的链接脚本，可以使用下面的指令将链接脚本的内容输出到终端：

```
ld --verbose
```
同时，可以将其重定位到文件再进行分析，但是一般而言，系统默认的链接脚本都是比较复杂的，我们将会在后续的文章中进一步分析。  

## 链接参数
链接脚本针对的主要是内存空间和地址分配部分，对于链接过程其它的部分，是链接器自动处理的，毕竟符号解析和重定位通常不会涉及到自定义的操作，同时，可以通过传入命令行参数来控制链接过程，使用 ld --help 可以查看所有的链接器参数，下面我们就来介绍几个比较常用的链接参数：

* -T：-T 参数表示指定链接脚本，用户可以通过 ld -T file 来指定使用自己的链接脚本，而不使用系统默认的，在一些特殊的场景中适用。  
* @file: 从文件中读取命令行参数，而不是手动指定，通常在脚本编程时使用这种做法。  
* -e entry、--entry=entry：这两个命令是同等效果，显示地指定程序开始的位置，通常情况下，需要指定程序内部的符号，如果给定的参数不是一个符号，链接器会尝试将参数解析成数字，表示从指定的地址开始执行程序。  
* -EB、-EL：指定大小端，这会覆盖掉系统默认的大小端设置。  
* -L、--library-path=searchdir：指定搜索的目录
* -l ：链接指定的库，库名通常是 libname.a 或者 libname.so，使用该参数时去掉库的前后缀，即 -lname
* -o output、--output=output：指定输出文件名
* -s、--strip-all：丢弃可执行文件中的符号，以减小尺寸。
* -static：不使用动态库，静态地链接
* -nostdlib：默认情况下链接标准库，该参数显示地指明不链接标准库。
* -shared：创建一个动态库


## 链接脚本
链接脚本主要的工作就是告诉链接器如果将各个目标文件、库中的段进行组织，生成输出文件，该输出文件可以是动态库、可执行文件，大部分的链接脚本都只做这个事，因此链接并不算是一个很难理解的过程。  





## 链接脚本详解





