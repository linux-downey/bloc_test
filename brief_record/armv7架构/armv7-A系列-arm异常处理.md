# armv7-A系列 - arm异常处理
在嵌入式中，中断这个概念渗透到方方面面，几乎每一场面试中，都会出现中断的知识点以检验面试者对嵌入式系统的了解程度，这无疑也是个难点，所以非常值得在讨论处理器时单独用一章的篇幅来分析中断的底层行为。  

当然，这仅仅是整个中断子系统的冰山一角，不过，了解处理器的异常处理是掌握整个 linux 中断系统的必经之路。  


## 异常类型
在处理器架构层面，软件中断、IRQ 和 FIQ 被统称为异常，异常还包括 Abort 和 undefined 指令等，在工作中最常接触的就是软件中断和 IRQ，所以从实际出发，这一章我们着重地分析软件中断和 IRQ 这两种在 linux 中占据重要地位的异常。  

在 linux 中，通常我们所说的软件中断就是通过 svc 指令发起，在老版本的 arm 架构中也被称为 swi，这两者互为别名的关系，并没有什么区别，软件中断即 svc 是用户空间进入内核空间的唯一通道，也是 linux 实现系统调用的关键所在。  

而 IRQ 则是指硬件中断，由 CPU 上引出一条 IRQ 线，这条 IRQ 线通常连接到 GIC(中断控制器) 上，GIC 向下再连接各外设，当外设产生中断信号时，经由 GIC 传递到 CPU 的 IRQ 引脚上，在 CPU 执行指令的间隙会查看是否有中断产生，如果有，则跳转到中断向量表的位置执行相应的异常处理程序。处理器的 IRQ 可以通过 CPSR 状态寄存器的中断屏蔽位屏蔽掉 IRQ。  

FIQ 在 linux 中并没有使用到，相对于 IRQ 而言，FIQ 拥有更高的优先级，它可以抢占 IRQ 的执行，同时 FIQ 本身的执行速度比 IRQ 要快一些，这类中断通常用在对响应时间有极高要求的系统中，比如 armv7-R 系列的处理器中会使用到。FIQ 的快速执行一方面体现在它有更高的优先级，另一方面，它拥有单独的寄存器，省去了参数的压栈时间，且处于中断向量表的最后一项，其执行代码不需要经过跳转。  

至于为什么 linux 中不使用 FIQ，同时禁止 IRQ 中断的嵌套，这是因为支持中断的嵌套会给系统带来更大的复杂性，同时，过多中断的嵌套很可能导致栈的溢出，另一方面，随着硬件的发展，系统性能的瓶颈并不受限于中断的处理，当然，禁止 FIQ 以及中断的嵌套会略微地降低实时性，但是明显它带来的那点实时性提升并不足以弥补它所带来的缺点，两相权衡之下，在新版的内核中便取消了中断嵌套的支持(老版本中是支持的).

## 中断向量表
向量表中保存了一系列的跳转指令，当系统发生异常时，由处理器负责将程序执行流转到向量表中的跳转指令，最常见的就是中断向量，应用工程师只需要使用固定的函数名编写中断处理程序，在中断发生时该中断处理程序就会被自动调用，这背后的实现就是中断向量表的功劳。  

在 armv7 中，中断向量表可以设置在两个地址：0x00000000 和 0xffff0000，由协处理器 cp15 的 SCTLR 的 bit13 来控制，默认情况下，中断向量表的位置在 0x00000000，实际上，对于操作系统而言，比如 linux，会更倾向于将中断向量表放在 0xffff0000 处，因为 0x0 处在用户空间下，需要额外做一些限制，而 0xffff0000 处在内核空间，另一方面，0 地址通常是 NULL 指针访问的地址，这需要 MMU 做相应的访问限制规则，总之，将向量表放在高地址处会更方便。

armv7 架构中向量表地址内容见下表：TODO

当对应的 exception event 发生时，系统会自动地修改 CPSR 状态寄存器，并跳转到上表中的地址执行指令，而软件上要做的，就是在该地址上放置对应的代码，除了 FIQ 之外，其它模式对应的都是一条跳转指令，如果存放多于 4 字节的指令，将会覆盖调用后续的异常向量，因为 FIQ 是最后一条异常向量，根据其特殊性，FIQ 的处理指令可以直接放置在以 oxffff001c 处，当然，具体怎么做由软件的实现来决定。  

比如，在 U-boot 中，armv7 对应的 vector.S 中(启动代码)可以看到这样的代码：

```
_start:
    b	reset
    ldr	pc, _undefined_instruction
    ldr	pc, _software_interrupt
    ldr	pc, _prefetch_abort
    ldr	pc, _data_abort
    ldr	pc, _not_used
    ldr	pc, _irq
    ldr	pc, _fiq
```
因为在链接脚本中定义了 ENTRY(_start)，所以程序的第一条指令就是 b reset，尽管后续的指令得不到执行，但是它们在编译链接之后就被放置在以 0x4 开始的地址处，每一条指令占4字节，从指令内容可以看出这些指令都是跳转指令。   

在汇编中标号表示标号之后的第一条指令的地址，比如，当发生 irq 中断时，处理器会强制跳转执行 ldr pc, _irq 这条指令，它的内容是这样的：

```
_irq:			.word irq

irq:
	get_irq_stack
	irq_save_user_regs      //保存断点
	bl	do_irq
	irq_restore_user_regs  //恢复断点
```

也就是说，中断向量表定义了在异常发生的那一刻，程序将要跳转执行的地址，这是由硬件自动进行设置的。  


## 异常的行为

