# armv7-A系列-核心寄存器以及使用
不论是对于哪种处理器而言，内部寄存器都是非常重要的一部分，它是处理器核心自带的内存，处理器核心的大部分操作都是在寄存器中完成，对于使用精简指令集的 arm 而言，所有操作都必须在寄存器中完成，不允许直接对内存进行操作，这更体现了内部寄存器的重要性，要了解 arm 处理器以及它的指令集，了解它的内部寄存器是第一步。  


## 核心寄存器
armv7 架构总共 16 个 32 位核心寄存器，其中 r0～r12 是通用寄存器，r13～r15 是特殊寄存器：
* r13 是 sp 寄存器，也是栈顶指针，保存着栈顶的位置。
* r14 为链接寄存器 lr，用于保存返回地址，用于执行流的跳转返回
* r15 为程序计数器 pc，保存下一条取指指令的地址。

sp 寄存器保存栈顶的位置，栈是自高地址向低地址增长的，所以在 push 和 pop 的过程中，sp 指针会自动地更新，同时，在一些特殊的情况下，sp 指针也可以被用作通用寄存器保存临时数据，但是并不建议这么做。  

lr 寄存器用于保存返回地址，但是程序的跳转往往伴随着嵌套，所以并不是所有的返回值都是由 lr 保存，通常在子程序的调用过程中更倾向于将返回地址 push 到栈中，lr 更多的是在中断的场景下应用，同样的，lr也可以被当成通用寄存器使用，但是并不建议这么使用。  

PC 是程序计数器，往 PC 中写入一个地址可以实现程序的跳转，也可以使用指令 B 或者 BL 实现程序跳转。因为 armv7 同时支持 arm 和 thumb 指令集，当处于 arm 指令集下时， PC 读取当前指令地址+8，当处于 thumb 指令集下时，PC 读取当前指令地址+4。arm 的处理器中引入了流水线技术，指令的执行需要经过取指、译码、执行三个步骤，这是经典的三级流水线结构，某些处理器甚至能达到 8 级流水线甚至更多，但是 PC 指针总是和前三个步骤相关。当前的指令为执行，下一条指令为译码，而下下条指令是取指，所以在 arm 指令集中，PC 的值是 当前指令地址 +8，表示取下下条指令，，而经典的 thumb 指令集为 16 位，所以是 +4。


## bank 寄存器
在某些资料中，arm 的核心寄存器数量描述为 37 个(armv6)，这是因为 arm 处理器中的 bank 寄存器。  

armv7 中定义了 8 种处理器模式，对于每一种处理器模式，尽管操作的寄存器名称一样，其操作的寄存器实体可能是不一样的，我们可以参考下图：TODO

比如，当从 user 模式进入到 svc 模式时，使用的是不同的 sp 和 lr 寄存器实体。    

bank 在 arm 处理器是一个常见的概念，意思是相同的外部接口对应内部不同的实现，这就像在程序中定义同名的全局变量和局部变量，尽管这两个变量的名称一样，但是对应不同的内存地址，在操作时自然互不相关。  

所以，如果以寄存器接口来算，寄存器为 16 个，如果以真正的寄存器实体来算，寄存器数量要算上 bank 类型的。  

注：armv7 中因为增加了系统模式，加上 bank 寄存器，数量为 40 多个。  


## 寄存器别名以及函数调用约定
在汇编程序中，就像寄存器 r13 可以使用 sp 来代替，为了方便使用以及功能区分，每一个寄存器都对应一个别名，且都对应一些默认的功能。  

### r0 ～ r3参数寄存器
r0 ～ r3 分别对应 a1 ～ a4，这四个寄存器专门用于函数的参数传递和返回值保存，在进行 C 语言的子程序调用时，r0 保存第一个参数、r1 保存第一个，以此类推，当函数参数多于 4 个时，剩下的参数将会被保存到栈上并传递到子程序中，压栈的顺序为从右到左。当程序执行到子程序中，子程序会将寄存器中的参数压栈，压栈的顺序为从右到左，即第一个参数会被放在栈顶的位置。  

子程序返回时，会将返回值保存在 r0 寄存器中，当返回值大于一个寄存器宽度时，将会由多个寄存器保存，比如一个 8 字节的返回值会由 r0 和 r1 保存，当返回值的size大于四个寄存器宽度时，返回值将会保存在内存中，将对应的内存地址保存在 r0 中返回。  


### 帧指针
在函数的调用过程中，通常使用栈帧结构，即 sp 指针总是指向程序的栈顶，同时设置一个帧指针来跟踪函数的调用，在每次函数调用时，帧指针都保存着当前函数在栈上的基地址，这样在函数返回时就可以非常方便地对栈上的内存资源进行回收。  

事实上，在 arm 官方的手册中，帧指针是 r11，r11 的别名也是 fp(frame point),但是在实际的编译器实现中，从反汇编代码可以看出，r7 被作为帧指针而不是官方指定的 r11，博主也不清楚为什么会有这种理论与实现上的出入。但是事实确实是这样。  


### r9 寄存器
r9 寄存器的使用是由平台指定的，不同平台可能将它实现成不同的作用，大体会有几种实现，它可以在位置无关代码中保存内存的静态地址，别名为 SB(static base)，在 Uboot 的实现中，r9 就被用来保存 global data 的起始地址。同时，它也可以被指定为线程寄存器，保存一些本地参数的地址，别名为 TR，thread register，在 cortex A 系列中，它通常被用作前者。r9 的另一个别名为 v6。  

### 程序调用暂存器
r12 寄存器又名为 ip 寄存器，它可以作为程序内调用暂存寄存器，


r4 ～ r8 分别对应 v1 ～ v5

r9  对应 v6，同时也可以使用 sb，static base。
r10 对应 v7
r11 对应 v8，同时也是 fp 寄存器
r12 为 ip 寄存器。  





## 状态寄存器
## 协处理器




arm 使用精简指令集，这是 arm 低功耗的关键所在，降低指令的复杂度，从而达到简化电路、优化功耗的效果。









