# linux 网络驱动程序 -- 数据链路层和物理层

作为一个驱动开发者，如果仅仅是开发一个网络驱动程序，可以在不了解任何网络协议的情况下完成这项工作，这完全得益于 linux 的网络子系统被设计成协议不相关模型。   

就像大部分字符设备驱动，开发的过程实际上完全可以只是个填空的过程：申请一个结构体，初始化其中一些必要的字段，然后注册结构体。

对于功能的实现，大可以这样，但是面对一些稍微复杂的需求，或者是在 debug 的时候，就需要对框架原理有一定的掌握。  

所以，在介绍 linux 的网络驱动程序之前，有必要先了解一下数据链路层和物理层，也就是网卡所工作的网络分层。  


## 网卡的功能
首先，需要知道的是：linux 中的网络驱动程序实际上就是网卡驱动程序，既然是驱动程序，目的自然驱动一块网卡可以在 linux 中正常工作，而网卡的功能是什么呢？  

答案很简单：收发数据。

网络七层模型也好、四层模型也好，网卡总是工作在最底层，不难理解：在接收时数据由网络接口流向网卡，在发送时数据从网卡流出。  

所以，网卡工作在数据链路层和物理层。



## 物理层
对于物理层，很多对网络一知半解的朋友一直有一些误区：
* 既然是物理层，那么自然对应硬件，从而不涉及软件。
* 网络的物理连接一定是网状的。

我既然这么说了，你自然就知道这两个说法是错的，至少是有所偏颇的。  

对于物理层的误解，通常是因为经典的网络实现并非基于标准的 OSI 七层模型，而是四层模型，在网络四层模型中，物理层被并入了数据链路层。   

事实上，物理层定义了通信的基础，也就是：数据是如何被传输的。  

一方面，数据传输需要基于特定的介质，就是信号传输的通道，比如最常见的双绞线、光纤等，以及在物理层定义接口的机械和电气特性，比如接口的形状、线序、传输介质的电压范围等，我们上网时使用的网线接头 RJ45 就是由物理层定义。  

另一方面，物理层同样负责传输数据，通过传输协议在物理介质上传输数据，同时还需要负责流控、必要的校验等，所以这部分软件的工作也是在物理层完成。  

同时，经典的网络实现拓扑结构是网状的，但是并非网络的物理连接就一定是网状的。  

OSI 七层网络模型分层的意义在于，对每一层都定义了相应的标准，层层之间相互独立，互不影响，只通过特定的形式进行交互，同时不能跨层交互。这种分层的模型在软件设计中大行其道，低耦合也给了软件实现更大的灵活性。  

当你对软件标准有了一定的了解，就会发现，标准通常只规定需要达到的目标，并不会限定实现的方式。  

这句话应用到物理层也是一样，只要能异步地进行数据传输，就可以作为网络中的物理层。  

比如常用的电话网络、EIARS-499，或者是无线的 wifi、Bluetooth，甚至是板级通信接口比如串口。  

当然你会有疑问，wifi、蓝牙作为物理层尚可以理解，但是串口明显只支持点对点的数据传输，为什么也可以作为物理层？   

首先，串口可以实现异步地传输数据，可以将链路层传过来的数据包传递到对端，而对端接收到数据包之后同样可以将数据包按照数据链路层的格式进行解析，然后一层一层往高层协议传，这在软件上是完全可以实现的，也是符合 OSI 模型的一种实现，同样可以对节点分配 IP 地址和 MAC 地址，以及使用 socket 编程进行通信。只是这种实现方式确实只支持点对点传输。   

又或者，在基于 RS485 的物理层之上，同样可以实现总线型的网络(RS485通信的拓扑结构为总线型：一主多从)。  

这一类特殊的实现在商用网络中非常少见，多出现在工业以太网中，这种实现的工业以太网同样符合 OSI 七层模型的标准。  

只是，我们习惯了以路由器/交换机为转发节点的网状拓扑方式，就以为网络的物理层实现标准就是如此。

## 数据链路层
数据链路层是基于物理层之上的层次，也是构成局域网的主体部分。  

正如上文所说：物理层负责传输数据。    

但是有几个问题并不关心：
* 传输什么样的数据？
* 是否能准确地将正确的数据传送到正确的目的地。  

这两点是数据传输中至关重要的部分，也正是数据链路层所做的事：帧编码、数据传输控制、链路管理。  

### 帧编码
首先，在数据发送时，数据链路层的数据是从上一层 IP 层传来的数据包，该层负责在 IP 数据包的基础上添加数据链路层的协议头、尾，以及定义一个数据包大小的上下限(MTU)等，协议头中包含了原地址、目的地址、数据类型这一类协议数据，又因为数据链路层的数据被称为帧，所以组织协议这一部分通常被视为帧编码。   

帧编码的意义在于：   

根据帧内的协议字段可以确认帧以及后续帧的解析。  

根据帧内的源/目的地址，正确地对包进行路由，将其发送到正确的目的地。  

通过校验位，可以及时地对数据进行纠错和排错。

### 链路管理
链路管理由 LLC 协议实现，它属于数据链路层子层中的上层，全称为Logic Link Control，意为逻辑链路控制。  

链路管理提供三种链路传输方式：
1、无连接的链路，不保证发送的信息可以收到
2、面向连接，提供连接的建立、确认、到达相应和纠错机制。  
3、无连接的应答响应服务。 

需要注意的是，链路属于软件上的概念，是逻辑通道，这需要和物理层进行区分，同样面向连接和非连接是链路层的传输实现，同样需要与 TCP/UDP 区分开来。

### 数据传输控制
数据传输控制由 mac 协议实现，它数据数据链路层子层中的下层，更贴近硬件，mac 的全称为 media access control，表示介质访问控制层。

数据传输控制：由于多个设备处于同一个局域网内，会出现多个设备共用一个传输介质的情况，传输时的冲突也需要数据链路层管理，最常见的解决以太网内冲突的方法是 CSMA/CD 即载波侦听多路访问/冲突检测，这种方法理解起来非常简单：主机通过载波侦听(一种物理方法，判断线路状态)确定当前链路上是否有主机在传输数据，如果没有就发送数据，即使是这样也有可能出现两个设备同时发送数据而导致冲突，这时候双方立即停止发送数据，这时采用一种叫二进制指数退避策略的算法来决定不同的节点在试图再次发送数据前要等待的时间（随机延迟）。   
链路层的最小帧长度 64 字节也是由此而定义，通过判断帧长度可以快速地确定收到的数据是不是因为冲突而中断发送的包，基于目前的硬件以及限定的传输距离内，主机开始发送数据到检测到冲突这段时间发送的数据不会达到 64 字节。


同时，一方数据传输过快而导致接收者处理不过来的情况也会时常发生，这时候也需要数据链路层进行流控以解决这种问题。


在讨论数据链路层时，很多朋友总会先入为主地把它当成是以太网，从而陷入一些误区，需要注意的是，数据链路层是局域网的主体部分，而以太网只是局域网的一种实现，局域网实现还包括 Wlan(wifi)、蓝牙、以及令牌环网等网络实现。
  

## 直观示例
两台电脑，如果想让它们之间通信，可以使用一根网线将两台机器连接起来，然后将它们的 IP 地址设置在同一个网段，这两台机器就可以相互 ping 通，自然也是可以使用网络接口进行通信，这就组成了一个最小的局域网。  

现在多了一台电脑，需要连到一起，按照多年以前的做法是把它们叁连接到一个共享电缆上，这三台机器设置在同一个 IP 网段，也是可以通信的，只是这样的通信有一个问题，机器 A 不管是发送给谁的数据，B 和 C 都能收到，因为三台机器共享同一根网线。  

现在一般不适用共享电缆，而是使用一个叫 hub 的东西，又叫集线器，hub 有多个网口，它所做的工作就是简简单单地将接收到的数据复制并发送到每个已连接的网口，实现效果和共享电缆一致，同样存在所有数据共享的问题，所以，hub 是属于物理层的设备，只负责数据的传输，没有任何流量控制的行为。

这种方式自然是会有效率以及安全性上的问题，问题得到解决是源于交换机的出现，从外观上来看交换机和 hub 差不多，都是有多个网口，但是功能上却大不一样，在一个局域网内，交换机负责将数据包准确地交付到目标主机，几乎不干扰非目标主机。   

为什么是几乎而不是完全呢？同样假设 A、B、C 三台主机连在交换机上，在交换机初始化时并不知道 A、B、C 三台机器的 mac 地址与端口的对应，当这时候网络中送达一个目标为 A 的包时，交换机从数据包中取出目标 MAC 地址，并向所有端口发送这个数据帧，B、C 发现这个数据帧不是自己的，遂丢弃该帧，而 A 接收该帧并回复，这时候交换机就记录下来 A 所对应的端口，以后所有 A 的数据流量都从这个端口走。  

这个过程被称为交换机的学习，这些记录下来的信息就叫 mac 地址表(端口地址)，当然，随着时间推移或者主机的上电下电，这个表会需要持续地更新。   

因此，交换机是工作在数据链路层的设备，除了控制数据的传输过程，同时负责数据链路的建立和流量的转发过滤。  








参考：百度百科:(https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82)







