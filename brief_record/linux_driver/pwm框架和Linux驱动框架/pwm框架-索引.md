# pwm 驱动框架

## 前言
linux 的内核驱动开发者、乃至于大多数计算机行业从业者，对"框架"这两个字自然是不陌生，除了裸机代码，我们无时不刻地在和各种"框架"打交道。  

自从开始学习 linux 的内核驱动以来，就饱受 linux 内核中各种框架之苦，甚至于在某些情况下十分简单的东西套上一层框架之后都变得难以理解，是的，放眼望去，"框架"都是一些难以理解，非常抽象的东西，甚至经常动不动就将一份完整的代码拆分得七零八落。  


或许，应该需要停下来想一想，框架是什么？为什么需要框架？

## 一个正能量的创业故事

### 初创
经过互联网行业数十年的摸爬滚打，小何积累了一定的财富和人脉，他终于下定决心要去完成学生时代就许下的梦想：创业。  

当然，创业是艰难的，尤其是互联网创业，尽管像小何这样的互联网老兵也是磕得几乎遍体鳞伤，但凭借多年的积累，总归是让自己的小公司走上了正轨，由小何成为了何总。  

公司发展伴随着更多的业务，之前所有的事项，包括商务、财务、开发、仓管都是亲力亲为，现在单打独斗的模式明显不够用了，因为事情变得越来越多、项目变得越来越复杂，那怎么办？自然是招人。  

先把仓管的任务分出去，毕竟堂堂一个老总，在收发货的问题上化花太多时间不值得，而核心的东西依旧自己把控。  

同时，由于多年的积累，厚积薄发，公司的发展也是平步青云，发现自己一个人把持商务、财务和开发有点力不从心，那就找几个自己信得过的手下，分管商务、财务、开发，逐渐地，一个公司就有了五个人。  

### 壮大
渐渐地，公司越来越壮大，开发人员觉得项目多，继续招人，于是自己的职位变成技术总监，而其他两个部门也同时效仿。而且商务发现自己的一部分业务可以独立出来一个市场部门，而自己专心谈业务。  

于是，一个大公司的雏形出来了：老总作为第一级、各个部门总监第二级、部门小组长第三级、普通员工第四级。

那么，管理怎么做呢？  

老总觉得这么多人自己也管不来啊，于是向各部长宣布：自己部门的人自己管好，出了问题我反正只找你们，我要腾出时间想公司战略！

各部长向各小组长宣布：自己组的组员自己管好，我负责组长与部门之间信息的协调，管不好我问你们的责！

小组长压力山大，于是把上面分配下来的任务拆分成一个一个环节，由各个组员负责，组员之间自然需要协作，工作的方式就是一个组员接受另一个组员的工作成果，然后做完自己的部分之后再交给下一个人。

但是，组员的工作不能等着上一个人做完，那就先把上一个组员要交给该组员的东西定义好，组员根据该接口定义做自己的事，这样就形成了并发。  

一切就像齿轮啮合一样地完美，老总决定公司战略、产品走向，商务负责谈业务，市场负责调研、宣传工作，财务负责理财。  

具体的工作呢？部长将工作目标分配给组长，往下组长将大块的工作拆分为小块分给组员，各组员之间根据定义好的输入输出完成自己的工作。  

### 扩张
不久之后，老总决定往外地扩展业务，那就开分公司！那分公司的组织架构呢？自然是照搬现公司的架构，以每个节点再去招人。  

### 烦恼
看着公司一帆风顺，何总每天也是红光满面，毕竟事业有成，某天下班碰到小黄正在打包工位上的工作物品，看样子是离职了，对于离职这种事，何总已经是习以为常了，毕竟各有各的想法，重新招一个人来顶替他的位置就好了。  

但是何总之前和小黄接触过，觉得这个小伙子做事挺不错的，上去问了两句，小黄明显表现出对主管的不满，但是回头一想，这种越级上报我该怎么求证呢？我还是得去问部长、部长再去找主管，于是回头又问了问主管，主管却说这个小伙子做事不行，既然这样，那也就不纠结了，但是后来发现该主管的表现非常一般，且招的人都是沾亲带故的，于是下令花大力气彻查此事。结果一出来，原来果然是主管的问题，老总突然觉得对那些被排挤离职的员工心存愧疚，不由得长叹：管理难啊！  


## 故事之后的思考
看到这里，大家都知道这是博主现编的一个故事，虽说是编的，但也是符合常理的。不知道作为工程师的你有没有什么共鸣。

或者，我们把开公司这件事换成写软件试试：

小何接手一个软件项目，刚开始工作量小，所有的功能都可以放在一个模块中实现。  

随着需求的不断增加，小何发现所有功能糅合在一起会让软件看起来越来越乱，过多的分支也让后期越来越不好维护。  

于是，将所有的需求梳理一遍，分为几个大的模块，每个模块负责处理一大块的事情，比如 A 模块负责硬件接口、B 模块负责数据处理、C 模块负责用户交互。  

但是，功能还是在接着添加，以硬件接口模块为例：硬件接口又分为 网口、串口、磁盘接口等，于是继续分层细化，每一个子模块负责一小部分工作，比如单独负责网口、单独负责串口、磁盘，每个模块定义清晰的输入输出接口，对每个小模块而言，接受并检查输入，然后根据定义做相应输出即可，这中间的处理过程与其他模块不相关。而原来的硬件接口部分则负责各个小模块之间的协调工作，比如数据的同步，进程线程的调度策略，其他的模块也按照这样的方式进行分化，层层分化处理，整个软件的开发效率就明显高了起来。  

这样做有什么好处呢？  
* 工作职责清晰，每个模块要做什么都清清楚楚，软件编写起来不容易乱，debug 也非常简单，很容易查出来哪个环节除了问题
* 如果需要替换模块，或者不用该模块了，只要替换这个模块就行了，新替换进来的模块同样是对上接受输入，对下输出，中间的处理过程不相关。

有了这一次的开发经验，小何成为了何总监，于是，在以后的软件开发中，何总监都决定使用这种层层分化的思想来写软件，同时，何总监将这套方法论写了下来，命名为"框架"。  

经过对比之后，惊人地发现，公司的发展结构和软件的发展结构竟是如此地相似：
* 公司从单打独斗到5人各掌一面对应着模块的第一次分化
* 部长分配任务，组长将任务细化，部长负责协调，对应着一个整体模块的拆分，各子模块之间通过预定的输入输出接口进行协作
* 开分公司对应着将方法论抽象出来，将这套已成型的框架剥离出来
* 员工离职->招新人顶其位置对应着模块的替换，而且此时替换的成本非常小，每个人负责非常明确的一部分
* 越级上报对应着越过框架的违规操作。

由此可见，框架其实早就不是什么新鲜的东西，上到国家系统，下到蜂群的分工，处处充斥着"框架"。  

只是在互联网的发展中，这种抽象在越来越庞大的软件中发挥得淋漓尽致，而"框架"二字也由此声名大噪。  


## 模块化和框架
看到这里，我们在你心目中，大概有了一个框架的概念：

**框架（Framework）是一个框子——指其约束性，也是一个架子——指其支撑性**

什么意思呢？从上面的示例其实可以有所了解，框架的底层支撑是模块化，模块化的原理是分层和分化，对于每个模块，明确地定义输入输出，也就是指其约束性，接收指定的输入，输出指定的内容。  

其支撑性则表现在整体上，框架并不解决具体的问题，它只是定义一个结构，使用者需要做的就是往结构中对应的部分填充符合框架要求的支持其输入输出的内容。


## 框架的弊端
上文一直在强调框架的优越性，那么，它有什么弊端吗？  

自然也是有的，在上文的结论中，框架的支撑是模块化，而模块化的实现依赖于输入输出接口，框架会带来大量的接口，所有的底层模块都是面向接口在工作。过多的接口抽象将导致程序的可读性变差，失去其连贯性，但是这仅对于某个功能模块而言，因为如果不使用模块化的思想，系统代码将挤成一团，那种情况下可读性将更差。模块化的作用是牺牲了局部的可读性，成全了整个系统的可读性。  

而且，接口本身的抽象以及对复用性的追求也会增加程序的开销，当然，对于大型系统，这些损失根本不值一提，但是在小型系统中，框架就发挥不出它的威力了，因为很可能业务代码还没有框架实现代码多。  

还有就是文章开头提到的：在一个复杂的框架中，实现一个很简单功能时，因为需要适应框架，反而变得非常麻烦。  

当然，上述所说的弊端都是在非常局限的条件下才会体现出来，远远比不上框架所带来的便利。  


